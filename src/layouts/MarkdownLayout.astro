---
import '../styles/global.css'
import global from '../data/global.yml'
import MainContent from '../components/MainContent.astro'
import TopBar from '../components/TopBar.astro'
import DesktopLeftSidebar from '../components/DesktopLeftSidebar.astro'
import FooterSection from '../components/ContextualColumn.astro'

const { frontmatter } = Astro.props
const { site } = global
const currentPath = Astro.url.pathname
const postModules = import.meta.glob('../content/news/*.mdx', { eager: true })
const news = Object.entries(postModules)
  .map(([file, mod], index) => {
    const post = mod as any
    const rawDate = post.frontmatter?.date

    return {
      id: post.frontmatter?.id ?? index + 1,
      title: post.frontmatter?.title || 'Cim nelkul',
      slug: file.split('/').pop()?.replace(/\.mdx?$/, '') || `news-${index + 1}`,
      date: rawDate ? new Date(rawDate).toISOString().split('T')[0] : '2026-03-01',
      excerpt: post.frontmatter?.excerpt || '',
      image: post.frontmatter?.image || '/images/ja-logo-magenta-blue-fekvo-for-dark-bg.svg',
      category: 'Hir',
      draft: post.frontmatter?.draft === true,
    }
  })
  .filter((post) => !post.draft)
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
const isIndexPage = currentPath === '/'
const showToc = isIndexPage
const sidebarNewsCount = frontmatter?.sidebarNewsCount ?? (isIndexPage ? 0 : 3)
const sidebarNews = showToc ? [] : news.slice(0, sidebarNewsCount)
const showNewsSidebar = !showToc && sidebarNews.length > 0
---

<html lang="hu">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{frontmatter?.title ? `${frontmatter.title} – ${site.title}` : site.title}</title>
    <meta name="description" content={frontmatter?.description || site.description} />
  </head>

  <body
    class="min-h-screen bg-gray-100 text-gray-800"
    x-data="{ sidebarOpen: false, tocOpen: false }"
    :class="{ 'overflow-hidden': sidebarOpen || tocOpen }"
    @keydown.window.escape="sidebarOpen = false; tocOpen = false"
  >
    <TopBar {showToc} />

    <!-- Fő konténer - max 1440px, középre igazítva -->
    <div class="relative mx-auto flex min-h-screen max-w-[1440px] flex-col bg-white lg:flex-row">
      <DesktopLeftSidebar />

      <MainContent {frontmatter}>
        <article class="prose prose-slate dark:prose-invert">
          <slot />
        </article>
      </MainContent>

      <FooterSection {showToc} {showNewsSidebar} {sidebarNews} />
    </div>

    <script>
      import '../scripts/alpine.js'
    </script>
  </body>
</html>
